<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/phaser-lifecycle-plugin.js | phaser-lifecycle-plugin</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<link rel="stylesheet" href="./inject/css/0-injected-style.css"><meta name="description" content="A Phaser 3 plugin to make it easier to have custom objects hook into Phaser&apos;s lifecycle events - preupdate, postupdate, etc."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="phaser-lifecycle-plugin"><meta property="twitter:description" content="A Phaser 3 plugin to make it easier to have custom objects hook into Phaser&apos;s lifecycle events - preupdate, postupdate, etc."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/sporadic-labs/phaser-lifecycle-plugin"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/phaser-lifecycle-plugin.js~LifecyclePlugin.html">LifecyclePlugin</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/phaser-lifecycle-plugin.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// TODO:
// - add config option to add() to allow custom mapping to update/preupdate/postupdate
// - add priority/
// - docs
// - more tests

import Phaser from &quot;phaser&quot;;

/**
 * Plugin that wraps around Phaser&apos;s event system. This allows us to avoid the issues around the
 * EventEmitter library Phaser uses where the EE caches the listeners at the start of an event. This
 * leads to bugs if a listener gets unsubscribed during an event (e.g. the physics system
 * unsubscribing a listener via a CB before the listener&apos;s update method). This plugin immediately
 * unsubscribes the listener.
 */
export default class LifecyclePlugin extends Phaser.Plugins.ScenePlugin {
  constructor(scene, pluginManager) {
    super(scene, pluginManager);

    this.scene = scene;
    this.systems = scene.sys;

    this.hasStarted = false;

    const camelCaseEvents = [
      &quot;update&quot;,
      &quot;preUpdate&quot;,
      &quot;postUpdate&quot;,
      &quot;render&quot;,
      &quot;shutdown&quot;,
      &quot;destroy&quot;,
      &quot;start&quot;,
      &quot;ready&quot;,
      &quot;boot&quot;,
      &quot;sleep&quot;,
      &quot;wake&quot;,
      &quot;pause&quot;,
      &quot;resume&quot;,
      &quot;resize&quot;,
      &quot;transitionInit&quot;,
      &quot;transitionStart&quot;,
      &quot;transitionOut&quot;,
      &quot;transitionComplete&quot;
    ];
    this.setEventsToTrack(camelCaseEvents);

    if (!scene.sys.settings.isBooted) this.systems.events.once(&quot;boot&quot;, this.boot, this);
  }

  setEventsToTrack(camelCaseEvents) {
    // Rather than selectively unsubing &amp; resubing, nuke all and resub later
    if (this.hasStarted) this.unsubscribeSceneEvents();

    this.eventNames = camelCaseEvents.map(s =&gt; s.toLowerCase());
    this.possibleMethodNames = new Set([...camelCaseEvents, ...this.eventNames]);

    const oldListeners = this.listeners || {};
    this.listeners = {};
    this.eventNames.forEach(name =&gt; {
      this.listeners[name] = oldListeners[name] ? oldListeners[name] : new Map();
    });

    this.eventHandlers = {};
    this.eventNames.forEach(name =&gt; {
      this.eventHandlers[name] = this.onSceneEvent.bind(this, name);
    });
    if (this.hasStarted) this.subscribeSceneEvents();
  }

  boot() {
    const emitter = this.systems.events;
    emitter.on(&quot;shutdown&quot;, this.shutdown, this);
    emitter.on(&quot;start&quot;, this.start, this);
    emitter.once(&quot;destroy&quot;, this.destroy, this);
  }

  start() {
    this.hasStarted = true;
    this.subscribeSceneEvents();
  }

  subscribeSceneEvents() {
    const emitter = this.systems.events;
    this.eventNames.forEach(name =&gt; emitter.on(name, this.eventHandlers[name]));
  }

  unsubscribeSceneEvents() {
    const emitter = this.systems.events;
    this.eventNames.forEach(name =&gt; emitter.off(name, this.eventHandlers[name]));
  }

  onSceneEvent(eventName, ...args) {
    this.listeners[eventName].forEach((method, object) =&gt; method.apply(object, args));
  }

  add(object, eventMapping) {
    // No mapping given, default to checking for methods named after the event
    if (!eventMapping) {
      eventMapping = {};
      this.possibleMethodNames.forEach(methodName =&gt; {
        if (typeof object[methodName] === &quot;function&quot;) {
          const eventName = methodName.toLowerCase();
          eventMapping[eventName] = object[methodName];
        }
      });
    }

    Object.entries(eventMapping).forEach(([eventName, method]) =&gt; {
      const listenerMap = this.listeners[eventName];
      if (listenerMap) listenerMap.set(object, method);
    });
  }

  remove(object) {
    this.eventNames.forEach(name =&gt; this.listeners[name].delete(object));
  }

  removeAll() {
    this.eventNames.forEach(name =&gt; this.listeners[name].clear());
  }

  shutdown() {
    this.hasStarted = false;
    this.removeAll();
    this.unsubscribeSceneEvents();
  }

  destroy() {
    if (this.eventHandlers[&quot;destroy&quot;]) this.eventHandlers[&quot;destroy&quot;]();
    const emitter = this.systems.events;
    emitter.off(&quot;shutdown&quot;, this.onShutdown, this);
    this.unsubscribeSceneEvents();
    this.removeAll();
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
